'use strict';Object.defineProperty(exports,"__esModule",{value:true});var _typeof=typeof Symbol==="function"&&typeof Symbol.iterator==="symbol"?function(obj){return typeof obj;}:function(obj){return obj&&typeof Symbol==="function"&&obj.constructor===Symbol&&obj!==Symbol.prototype?"symbol":typeof obj;};var _extends=Object.assign||function(target){for(var i=1;i<arguments.length;i++){var source=arguments[i];for(var key in source){if(Object.prototype.hasOwnProperty.call(source,key)){target[key]=source[key];}}}return target;};var _createClass=function(){function defineProperties(target,props){for(var i=0;i<props.length;i++){var descriptor=props[i];descriptor.enumerable=descriptor.enumerable||false;descriptor.configurable=true;if("value"in descriptor)descriptor.writable=true;Object.defineProperty(target,descriptor.key,descriptor);}}return function(Constructor,protoProps,staticProps){if(protoProps)defineProperties(Constructor.prototype,protoProps);if(staticProps)defineProperties(Constructor,staticProps);return Constructor;};}();var _react=require('react');var _react2=_interopRequireDefault(_react);var _semanticUiReact=require('semantic-ui-react');function _interopRequireDefault(obj){return obj&&obj.__esModule?obj:{default:obj};}function _defineProperty(obj,key,value){if(key in obj){Object.defineProperty(obj,key,{value:value,enumerable:true,configurable:true,writable:true});}else{obj[key]=value;}return obj;}function _classCallCheck(instance,Constructor){if(!(instance instanceof Constructor)){throw new TypeError("Cannot call a class as a function");}}function _possibleConstructorReturn(self,call){if(!self){throw new ReferenceError("this hasn't been initialised - super() hasn't been called");}return call&&(typeof call==="object"||typeof call==="function")?call:self;}function _inherits(subClass,superClass){if(typeof superClass!=="function"&&superClass!==null){throw new TypeError("Super expression must either be null or a function, not "+typeof superClass);}subClass.prototype=Object.create(superClass&&superClass.prototype,{constructor:{value:subClass,enumerable:false,writable:true,configurable:true}});if(superClass)Object.setPrototypeOf?Object.setPrototypeOf(subClass,superClass):subClass.__proto__=superClass;}var propTypes={schema:_react.PropTypes.object,query:_react.PropTypes.func,data:_react.PropTypes.oneOfType([_react.PropTypes.object,_react.PropTypes.boolean]),fields:_react.PropTypes.array,update:_react.PropTypes.func,collectFieldsData:_react.PropTypes.func,getRequestString:_react.PropTypes.func,remove:_react.PropTypes.func,currentItemId:_react.PropTypes.oneOfType([_react.PropTypes.string,_react.PropTypes.boolean]),uploadImage:_react.PropTypes.func,addNewItem:_react.PropTypes.func};var defaultProps={schema:{},query:function query(){},data:{},fields:[],update:function update(){},collectFieldsData:function collectFieldsData(){},getRequestString:function getRequestString(){},remove:function remove(){},currentItemId:'',uploadImage:function uploadImage(){},addNewItem:function addNewItem(){}};var View=function(_Component){_inherits(View,_Component);function View(){var _ref;_classCallCheck(this,View);for(var _len=arguments.length,args=Array(_len),_key=0;_key<_len;_key++){args[_key]=arguments[_key];}var _this=_possibleConstructorReturn(this,(_ref=View.__proto__||Object.getPrototypeOf(View)).call.apply(_ref,[this].concat(args)));_this.getOptionsForModal=_this.getOptionsForModal.bind(_this);_this.addSelectOption=_this.addSelectOption.bind(_this);_this.generateModal=_this.generateModal.bind(_this);_this.getSelectData=_this.getSelectData.bind(_this);_this.generateFields=_this.generateFields.bind(_this);_this.checkIfDisabled=_this.checkIfDisabled.bind(_this);_this.getPopupImgPath=_this.getPopupImgPath.bind(_this);_this.initStatesForSelector=_this.initStatesForSelector.bind(_this);_this.state={schema:_this.props.schema,fields:_this.props.fields,data:_this.props.data,currentItemId:_this.props.currentItemId,popupImgLink:false};_this.initStatesForSelector(_this.props.fields);return _this;}_createClass(View,[{key:'componentWillMount',value:function componentWillMount(){var _state=this.state,fields=_state.fields,data=_state.data;this.getSelectData(fields,data);}},{key:'componentWillReceiveProps',value:function componentWillReceiveProps(){this.setState({data:this.props.data,currentItemId:this.props.currentItemId});}},{key:'getDateValue',value:function getDateValue(arg){var date=new Date(arg);var y=date.getFullYear();var m=(date.getMonth()+1).toString().length===2?date.getMonth()+1:'0'+(date.getMonth()+1);var d=date.getDate().toString().length===2?date.getDate():'0'+date.getDate();return y+'-'+m+'-'+d;}},{key:'getSelectData',value:function getSelectData(fields,data){var _this2=this;fields.forEach(function(field){var propName=Object.keys(field)[0];if(field[propName].inputControl==='selection'){(function(){var _this2$setState;var options=[];var defaultOptions=[];var dataForOptions=[];var label=field[propName].list.label?field[propName].list.label:Object.keys(field[propName].nestedFields[1])[0];var hasOwnAPI=Object.keys(field[propName].list.resolvers.find.args).length!==0&&Object.keys(field[propName].list.resolvers.create.args).length!==0;if(!hasOwnAPI&&data){data[propName].forEach(function(obj,idx){defaultOptions.push(idx);dataForOptions.push(obj);options.push({text:obj[label],value:idx});});}else if(hasOwnAPI){var resolver=field[propName].list.resolvers.find.resolver;var request=_this2.props.getRequestString(field[propName].nestedFields);_this2.props.query('query',request,resolver).then(function(res){res.data[field[propName].list.resolvers.find.resolver].forEach(function(obj,idx){dataForOptions.push(obj);options.push({text:obj[label],value:idx});var statement=data[propName].find(function(item){var response=void 0;if(item.id){response=item.id===obj.id;}else if(item._id){response=item._id===obj._id;}return response;});if(data&&statement)defaultOptions.push(idx);});}).catch(function(err){throw new Error(propName+', getSelectData, error: '+err);});}_this2.setState((_this2$setState={},_defineProperty(_this2$setState,propName+'DefaultValue',defaultOptions),_defineProperty(_this2$setState,propName+'Data',dataForOptions),_defineProperty(_this2$setState,propName,options),_this2$setState),function(){setTimeout(function(){return _this2.refs[propName].forceUpdate();},1);});})();}});}},{key:'getOptionsForModal',value:function getOptionsForModal(e,fields){e.preventDefault();this.getSelectData(fields);}},{key:'getPopupImgPath',value:function getPopupImgPath(propName){if(propName){var p=document.getElementById(propName+'-p');var uploadPath=this.props.schema.uploadPath?this.fixPath(this.props.schema.uploadPath):this.props.schema.typeName;this.setState({popupImgLink:uploadPath+'/'+p.innerText});}}},{key:'fixPath',value:function fixPath(string){var response='';if(string.slice(0,1)==='/'||string.slice(0,1)==='.'){response=string;}else{response='/'+string;}if(response.slice(-1)==='/'){response=response.slice(0,-1);}return response;}},{key:'isDate',value:function isDate(val){var d=new Date(val);return!isNaN(d.valueOf())&&typeof val!=='boolean'&&typeof val!=='number'&&typeof+val!=='number';}},{key:'addSelectOption',value:function addSelectOption(e,_ref2){var _setState;var label=_ref2.label,fields=_ref2.fields;var propName=e.currentTarget.name;var data=this.props.collectFieldsData(fields,false,false,propName);var newState=this.state[propName];var newData=this.state[propName+'Data']?this.state[propName+'Data']:[];newState.push({text:label?data[label]:data[Object.keys(data)[1]],value:+newState.length});newData.push(data);this.setState((_setState={},_defineProperty(_setState,propName,newState),_defineProperty(_setState,propName+'Data',newData),_setState),function(){document.querySelector('.modals').click();});}},{key:'checkIfDisabled',value:function checkIfDisabled(field,propName){var method=this.state.data?this.state.schema.resolvers.update.args:this.state.schema.resolvers.create.args;return method[propName]?field[propName].disabled:true;}},{key:'checkOnEnterIfTextarea',value:function checkOnEnterIfTextarea(e){if(e.target.nodeName==='INPUT'&&e.target.value.length>100){var textarea=document.createElement('textarea');textarea.id=e.target.id;textarea.placeholder=e.target.placeholder;textarea.innerText=e.target.value;e.target.parentNode.insertBefore(textarea,e.target);e.target.parentNode.removeChild(e.target);document.getElementById(textarea.id).focus();}}},{key:'initStatesForSelector',value:function initStatesForSelector(fields){var _this3=this;fields.forEach(function(field){if(field[Object.keys(field)[0]].inputControl==='selection'){_this3.state[Object.keys(field)[0]]=[];}});}},{key:'generateModal',value:function generateModal(fields,propName){var _this4=this;var to=(fields[propName].nestedFields.length/2).toFixed(0);var from=fields[propName].nestedFields.length-to;return _react2.default.createElement(_semanticUiReact.Modal,{id:propName+'Modal',trigger:_react2.default.createElement(_semanticUiReact.Button,{icon:true,className:'selector-add',onClick:function onClick(e){return _this4.getOptionsForModal(e,fields[propName].nestedFields);}},_react2.default.createElement(_semanticUiReact.Icon,{name:'plus'})),className:'graphql-cms_modal graphql-cms'},_react2.default.createElement(_semanticUiReact.Modal.Header,null,'Add new select option for "',propName,'"',_react2.default.createElement('div',{className:'btn-row'},_react2.default.createElement(_semanticUiReact.Button,{type:'submit',color:'black',name:propName,onClick:function onClick(e){return _this4.addSelectOption(e,{fields:fields[propName].nestedFields,label:fields[propName].list.label});}},'add'))),_react2.default.createElement(_semanticUiReact.Modal.Content,null,_react2.default.createElement(_semanticUiReact.Grid,{as:_semanticUiReact.Form},_react2.default.createElement(_semanticUiReact.Grid.Column,{computer:8,mobile:16},fields[propName].nestedFields.slice(0,to).map(function(field,idx){return _this4.generateFields(field,idx,false,false,propName+'/');})),_react2.default.createElement(_semanticUiReact.Grid.Column,{computer:8,mobile:16},fields[propName].nestedFields.slice(-from).map(function(field,idx){return _this4.generateFields(field,idx,false,false,propName+'/');})))));}},{key:'generateFields',value:function generateFields(obj,idx,data,dis,prefix){var _this5=this;var pr=prefix?prefix:'';var fields=_extends({},obj);var propName=Object.keys(fields)[0];var popupImgLink=this.state.popupImgLink;var value='';var checked='';var dateInput=false;var disabled=typeof dis==='boolean'?dis:this.checkIfDisabled(fields,propName);var control=fields[propName].inputControl;var DOM=void 0;if(fields[propName].nestedFields&&fields[propName].nestedFields[0]&&fields[propName].inputControl!=='selection'){var _ret2=function(){disabled=fields[propName].disabled;var newData=data?data[propName]:false;return{v:_react2.default.createElement('div',{className:'nestedFields',key:idx},_react2.default.createElement(_semanticUiReact.Divider,{horizontal:true},propName,' ',_react2.default.createElement(_semanticUiReact.Icon,{name:'level down'})),fields[propName].nestedFields.map(function(field,index){return _this5.generateFields(field,index+300,newData,disabled,propName+'/');}),_react2.default.createElement(_semanticUiReact.Divider,{horizontal:true},propName,' ',_react2.default.createElement(_semanticUiReact.Icon,{name:'level up'})))};}();if((typeof _ret2==='undefined'?'undefined':_typeof(_ret2))==="object")return _ret2.v;}if(data&&(data[propName]||typeof data[propName]==='boolean')&&fields[propName].inputType!=='file'){value=data[propName];if(value.length>100){control='textarea';}}else{value='';}if(data&&fields[propName].inputType==='checkbox'){checked=!data?false:data[propName];}else{checked=false;}if(this.isDate(value)||propName==='createdAt'||propName==='updatedAt'||propName==='deletedAt'||fields[propName].inputType==='date'){dateInput='date';value=!data?'':this.getDateValue(value);}var type=dateInput||fields[propName].inputType;if(data||propName!=='id'&&propName!=='_id'&&propName!=='offset'&&propName!=='limit'){if(type==='file'){DOM=_react2.default.createElement('div',{className:'file-form',key:idx},_react2.default.createElement(_semanticUiReact.Button,{as:'label',content:fields[propName].label,className:'file-form-btn',icon:'upload',disabled:disabled,labelPosition:'right',htmlFor:''+pr+propName+'-input'}),_react2.default.createElement(_semanticUiReact.Popup,{onMount:function onMount(){return _this5.getPopupImgPath(propName);},onClose:function onClose(){return _this5.getPopupImgPath(false);},name:propName,trigger:_react2.default.createElement('p',{className:'file-name',id:''+pr+propName+'-p'},data[propName])},_react2.default.createElement('img',{id:''+pr+propName+'-img',src:popupImgLink,alt:propName})),_react2.default.createElement('input',{disabled:disabled,onChange:this.props.uploadImage,id:''+pr+propName+'-input',type:'file'}));}else if(fields[propName].inputControl==='selection'){var options=this.state[propName];var defaultOptions=data?this.state[propName+'DefaultValue']:[];var hasOwnAPI=Object.keys(fields[propName].list.resolvers.find.args).length!==0&&Object.keys(fields[propName].list.resolvers.create.args).length!==0;DOM=_react2.default.createElement('div',{className:'file-form',key:idx},_react2.default.createElement('label',null,fields[propName].label),!hasOwnAPI?this.generateModal(fields,propName):null,options?_react2.default.createElement(_semanticUiReact.Dropdown,{ref:propName,placeholder:fields[propName].label,id:''+pr+propName,fluid:true,multiple:true,selection:true,search:true,defaultValue:defaultOptions,options:options}):null);}else{DOM=_react2.default.createElement(_semanticUiReact.Form.Field,{key:idx,label:fields[propName].label,control:control,type:type,id:''+pr+propName,defaultValue:value,defaultChecked:checked,onInput:this.checkOnEnterIfTextarea,disabled:disabled,placeholder:propName});}}return DOM;}},{key:'render',value:function render(){var Column=_semanticUiReact.Grid.Column;var _state2=this.state,fields=_state2.fields,schema=_state2.schema,currentItemId=_state2.currentItemId,data=_state2.data;var _props=this.props,update=_props.update,remove=_props.remove,addNewItem=_props.addNewItem;var generateFields=this.generateFields;var to=(fields.length/2).toFixed(0);var from=fields.length-to;return _react2.default.createElement(_semanticUiReact.Segment,{color:'black',className:'View'},_react2.default.createElement('div',{className:'btn-row'},currentItemId?_react2.default.createElement(_semanticUiReact.Button,{type:'submit',color:'black',onClick:addNewItem,disabled:!schema.resolvers.create},'add new'):null,_react2.default.createElement(_semanticUiReact.Button,{type:'submit',color:'black',onClick:!schema.resolvers.update?null:update,disabled:!schema.resolvers.update},'save'),_react2.default.createElement(_semanticUiReact.Button,{type:'submit',color:'black',id:currentItemId,onClick:!schema.resolvers.remove?null:remove,disabled:!schema.resolvers.remove},'remove')),_react2.default.createElement(_semanticUiReact.Grid,{as:_semanticUiReact.Form},_react2.default.createElement(Column,{computer:8,mobile:16},fields.slice(0,to).map(function(field,idx){return generateFields(field,idx,data);})),_react2.default.createElement(Column,{computer:8,mobile:16},fields.slice(-from).map(function(field,idx){return generateFields(field,idx,data);}))));}}]);return View;}(_react.Component);View.propTypes=propTypes;View.defaultProps=defaultProps;exports.default=View;