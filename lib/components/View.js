'use strict';Object.defineProperty(exports,"__esModule",{value:true});var _typeof=typeof Symbol==="function"&&typeof Symbol.iterator==="symbol"?function(obj){return typeof obj;}:function(obj){return obj&&typeof Symbol==="function"&&obj.constructor===Symbol&&obj!==Symbol.prototype?"symbol":typeof obj;};var _extends=Object.assign||function(target){for(var i=1;i<arguments.length;i++){var source=arguments[i];for(var key in source){if(Object.prototype.hasOwnProperty.call(source,key)){target[key]=source[key];}}}return target;};var _createClass=function(){function defineProperties(target,props){for(var i=0;i<props.length;i++){var descriptor=props[i];descriptor.enumerable=descriptor.enumerable||false;descriptor.configurable=true;if("value"in descriptor)descriptor.writable=true;Object.defineProperty(target,descriptor.key,descriptor);}}return function(Constructor,protoProps,staticProps){if(protoProps)defineProperties(Constructor.prototype,protoProps);if(staticProps)defineProperties(Constructor,staticProps);return Constructor;};}();var _react=require('react');var _react2=_interopRequireDefault(_react);var _semanticUiReact=require('semantic-ui-react');function _interopRequireDefault(obj){return obj&&obj.__esModule?obj:{default:obj};}function _defineProperty(obj,key,value){if(key in obj){Object.defineProperty(obj,key,{value:value,enumerable:true,configurable:true,writable:true});}else{obj[key]=value;}return obj;}function _classCallCheck(instance,Constructor){if(!(instance instanceof Constructor)){throw new TypeError("Cannot call a class as a function");}}function _possibleConstructorReturn(self,call){if(!self){throw new ReferenceError("this hasn't been initialised - super() hasn't been called");}return call&&(typeof call==="object"||typeof call==="function")?call:self;}function _inherits(subClass,superClass){if(typeof superClass!=="function"&&superClass!==null){throw new TypeError("Super expression must either be null or a function, not "+typeof superClass);}subClass.prototype=Object.create(superClass&&superClass.prototype,{constructor:{value:subClass,enumerable:false,writable:true,configurable:true}});if(superClass)Object.setPrototypeOf?Object.setPrototypeOf(subClass,superClass):subClass.__proto__=superClass;}var View=function(_Component){_inherits(View,_Component);function View(props){_classCallCheck(this,View);var _this=_possibleConstructorReturn(this,(View.__proto__||Object.getPrototypeOf(View)).call(this,props));_this.state={schema:_this.props.schema,fields:_this.props.fields,data:_this.props.data,currentItemId:_this.props.currentItemId,popupImgLink:false};_this.getOptionsForModal=_this.getOptionsForModal.bind(_this);_this.generateModal=_this.generateModal.bind(_this);_this.getSelectData=_this.getSelectData.bind(_this);_this.generateFields=_this.generateFields.bind(_this);_this.checkIfDisabled=_this.checkIfDisabled.bind(_this);_this.initStatesForSelector=_this.initStatesForSelector.bind(_this);_this.initStatesForSelector(_this.props.fields);return _this;}_createClass(View,[{key:'componentWillMount',value:function componentWillMount(){var _state=this.state,fields=_state.fields,data=_state.data;this.getSelectData(fields,data);}},{key:'componentWillReceiveProps',value:function componentWillReceiveProps(){this.setState({data:this.props.data,currentItemId:this.props.currentItemId});}},{key:'initStatesForSelector',value:function initStatesForSelector(fields){var _this2=this;fields.forEach(function(field){if(field[Object.keys(field)[0]].inputControl==='selection'){_this2.state[Object.keys(field)[0]]=[];}});}},{key:'getDateValue',value:function getDateValue(arg){var date=new Date(arg),y=date.getFullYear(),m=(date.getMonth()+1).toString().length===2?date.getMonth()+1:'0'+(date.getMonth()+1),d=date.getDate().toString().length===2?date.getDate():'0'+date.getDate();return y+'-'+m+'-'+d;}},{key:'checkOnEnterIfTextarea',value:function checkOnEnterIfTextarea(e){if(e.target.nodeName==='INPUT'&&e.target.value.length>100){var textarea=document.createElement('textarea');textarea.id=e.target.id;textarea.placeholder=e.target.placeholder;textarea.innerText=e.target.value;e.target.parentNode.insertBefore(textarea,e.target);e.target.parentNode.removeChild(e.target);document.getElementById(textarea.id).focus();}}},{key:'checkIfDisabled',value:function checkIfDisabled(field,propName){var method=this.state.data?this.state.schema.resolvers.update.args:this.state.schema.resolvers.create.args;return method[propName]?field[propName].disabled:true;}},{key:'getOptionsForModal',value:function getOptionsForModal(fields,e){e.preventDefault();this.getSelectData(fields);}},{key:'addSelectOption',value:function addSelectOption(_ref,e){var label=_ref.label,fields=_ref.fields;var propName=e.currentTarget.name,data=this.props._collectFieldsData(fields,false,false,propName),newState=this.state[propName];newState.push({text:label?data[label]:data[Object.keys(data)[1]],value:+newState.length});this[propName+'Data']=data;this.setState(_defineProperty({},propName,newState),function(){document.querySelector('.modals').click();});}},{key:'isDate',value:function isDate(val){var d=new Date(val);return!isNaN(d.valueOf())&&typeof val!=='boolean'&&typeof val!=='number'&&typeof+val!=='number';}},{key:'fixPath',value:function fixPath(string){var result='';string.slice(0,1)==='/'||string.slice(0,1)==='.'?result=string:result='/'+string;result.slice(-1)==='/'?result=result.slice(0,-1):null;return result;}},{key:'getPopupImgPath',value:function getPopupImgPath(propName){if(propName){var p=document.getElementById(propName+'-p'),uploadRoot=this.fixPath(this.props.schema.uploadRoot),uploadPath=this.props.schema.uploadPath?this.fixPath(this.props.schema.uploadPath):'';this.setState({popupImgLink:''+uploadRoot+uploadPath+'/'+p.innerText});}else{this.setState({popupImgLink:false});}}},{key:'getSelectData',value:function getSelectData(fields,data){var _this3=this;fields.forEach(function(field){var propName=Object.keys(field)[0];if(field[propName].inputControl==='selection'){(function(){var _this3$setState;var options=[],defaultOptions=[],dataForOptions=[],label=field[propName].list.label?field[propName].list.label:Object.keys(field[propName].nestedFields[1])[0],hasOwnAPI=Object.keys(field[propName].list.resolvers.find.args).length!==0&&Object.keys(field[propName].list.resolvers.create.args).length!==0;if(!hasOwnAPI&&data){data[propName].forEach(function(obj,idx){defaultOptions.push(idx);dataForOptions.push(obj);options.push({text:obj[label],value:idx});});}else if(hasOwnAPI){var resolver=field[propName].list.resolvers.find.resolver,request=_this3.props.getRequestString(field[propName].nestedFields);_this3.props.query('query',request,resolver).then(function(res){res.data[field[propName].list.resolvers.find.resolver].forEach(function(obj,idx){dataForOptions.push(obj);options.push({text:obj[label],value:idx});if(data&&data[propName].find(function(item){if(item.id){return item.id===obj.id;}else if(item._id){return item._id===obj._id;}})){defaultOptions.push(idx);}});}).catch(function(err){return console.log(propName+', getSelectData, error: '+err);});}_this3.setState((_this3$setState={},_defineProperty(_this3$setState,propName+'DefaultValue',defaultOptions),_defineProperty(_this3$setState,propName+'Data',dataForOptions),_defineProperty(_this3$setState,propName,options),_this3$setState),function(){setTimeout(function(){return _this3.refs[propName].forceUpdate();},1);});})();}});}},{key:'generateModal',value:function generateModal(field,propName){var _this4=this;var to=(field[propName].nestedFields.length/2).toFixed(0),from=field[propName].nestedFields.length-to;return _react2.default.createElement(_semanticUiReact.Modal,{id:propName+'Modal',trigger:_react2.default.createElement(_semanticUiReact.Button,{icon:true,className:'selector-add',onClick:this.getOptionsForModal.bind(this,field[propName].nestedFields)},_react2.default.createElement(_semanticUiReact.Icon,{name:'plus'})),className:'graphql-cms_modal graphql-cms'},_react2.default.createElement(_semanticUiReact.Modal.Header,null,'Add new select option for "',propName,'"',_react2.default.createElement('div',{className:'btn-row'},_react2.default.createElement(_semanticUiReact.Button,{type:'submit',color:'black',name:propName,onClick:this.addSelectOption.bind(this,{fields:field[propName].nestedFields,label:field[propName].list.label})},'add'))),_react2.default.createElement(_semanticUiReact.Modal.Content,null,_react2.default.createElement(_semanticUiReact.Grid,{as:_semanticUiReact.Form},_react2.default.createElement(_semanticUiReact.Grid.Column,{computer:8,mobile:16},field[propName].nestedFields.slice(0,to).map(function(field,idx){return _this4.generateFields(field,idx,false,false,propName+'/');})),_react2.default.createElement(_semanticUiReact.Grid.Column,{computer:8,mobile:16},field[propName].nestedFields.slice(-from).map(function(field,idx){return _this4.generateFields(field,idx,false,false,propName+'/');})))));}},{key:'generateFields',value:function generateFields(obj,idx,data,dis,prefix){var _this5=this;var pr=prefix?prefix:'',field=_extends({},obj),propName=Object.keys(field)[0],value='',checked='',dateInput=false,disabled=typeof dis==='boolean'?dis:this.checkIfDisabled(field,propName),control=field[propName].inputControl,_uploadImage=this.props._uploadImage,popupImgLink=this.state.popupImgLink;if(field[propName].nestedFields&&field[propName].nestedFields[0]&&field[propName].inputControl!=='selection'){var _ret2=function(){disabled=field[propName].disabled;var newData=data?data[propName]:false;return{v:_react2.default.createElement('div',{className:'nestedFields',key:idx},_react2.default.createElement(_semanticUiReact.Divider,{horizontal:true},propName,' ',_react2.default.createElement(_semanticUiReact.Icon,{name:'level down'})),field[propName].nestedFields.map(function(field,idx){return _this5.generateFields(field,idx+300,newData,disabled,propName+'/');}),_react2.default.createElement(_semanticUiReact.Divider,{horizontal:true},propName,' ',_react2.default.createElement(_semanticUiReact.Icon,{name:'level up'})))};}();if((typeof _ret2==='undefined'?'undefined':_typeof(_ret2))==="object")return _ret2.v;}if(data&&(data[propName]||typeof data[propName]==='boolean')&&field[propName].inputType!=='file'){value=data[propName];if(value.length>100){control='textarea';}}else{value='';}if(data&&field[propName].inputType==='checkbox'){checked=!data?false:data[propName];}else{checked=false;}if(this.isDate(value)||propName==='createdAt'||propName==='updatedAt'||propName==='deletedAt'||field[propName].inputType==='date'){dateInput='date';value=!data?'':this.getDateValue(value);}var type=dateInput||field[propName].inputType;if(data||propName!=='id'&&propName!=='_id'&&propName!=='offset'&&propName!=='limit'){if(type==='file'){return _react2.default.createElement('div',{className:'file-form',key:idx},_react2.default.createElement(_semanticUiReact.Button,{as:'label',content:field[propName].label,className:'file-form-btn',icon:'upload',disabled:disabled,labelPosition:'right',htmlFor:''+pr+propName+'-input'}),_react2.default.createElement(_semanticUiReact.Popup,{onMount:this.getPopupImgPath.bind(this,propName),onClose:this.getPopupImgPath.bind(this,false),name:propName,trigger:_react2.default.createElement('p',{className:'file-name',id:''+pr+propName+'-p'},data[propName])},_react2.default.createElement('img',{id:''+pr+propName+'-img',src:popupImgLink})),_react2.default.createElement('input',{disabled:disabled,onChange:_uploadImage,id:''+pr+propName+'-input',type:'file'}));}else if(field[propName].inputControl==='selection'){var options=this.state[propName],defaultOptions=data?this.state[propName+'DefaultValue']:[],hasOwnAPI=Object.keys(field[propName].list.resolvers.find.args).length!==0&&Object.keys(field[propName].list.resolvers.create.args).length!==0;return _react2.default.createElement('div',{className:'file-form',key:idx},_react2.default.createElement('label',null,field[propName].label),!hasOwnAPI?this.generateModal(field,propName):null,options?_react2.default.createElement(_semanticUiReact.Dropdown,{ref:propName,placeholder:field[propName].label,id:''+pr+propName,fluid:true,multiple:true,selection:true,search:true,defaultValue:defaultOptions,options:options}):null);}else{return _react2.default.createElement(_semanticUiReact.Form.Field,{key:idx,label:field[propName].label,control:control,type:type,id:''+pr+propName,defaultValue:value,defaultChecked:checked,onInput:this.checkOnEnterIfTextarea,disabled:disabled,placeholder:propName});}}}},{key:'render',value:function render(){var Column=_semanticUiReact.Grid.Column;var _state2=this.state,fields=_state2.fields,schema=_state2.schema,currentItemId=_state2.currentItemId,data=_state2.data;var _props=this.props,update=_props.update,remove=_props.remove,_addNewItem=_props._addNewItem,generateFields=this.generateFields,to=(fields.length/2).toFixed(0),from=fields.length-to;return _react2.default.createElement(_semanticUiReact.Segment,{color:'black',className:'View'},_react2.default.createElement('div',{className:'btn-row'},currentItemId?_react2.default.createElement(_semanticUiReact.Button,{type:'submit',color:'black',onClick:_addNewItem,disabled:!schema.resolvers.create},'add new'):null,_react2.default.createElement(_semanticUiReact.Button,{type:'submit',color:'black',onClick:!schema.resolvers.update?null:update,disabled:!schema.resolvers.update},'save'),_react2.default.createElement(_semanticUiReact.Button,{type:'submit',color:'black',id:currentItemId,onClick:!schema.resolvers.remove?null:remove,disabled:!schema.resolvers.remove},'remove')),_react2.default.createElement(_semanticUiReact.Grid,{as:_semanticUiReact.Form},_react2.default.createElement(Column,{computer:8,mobile:16},fields.slice(0,to).map(function(field,idx){return generateFields(field,idx,data);})),_react2.default.createElement(Column,{computer:8,mobile:16},fields.slice(-from).map(function(field,idx){return generateFields(field,idx,data);}))));}}]);return View;}(_react.Component);View.propTypes={schema:_react.PropTypes.object,query:_react.PropTypes.func,data:_react.PropTypes.oneOfType([_react.PropTypes.object,_react.PropTypes.boolean]),fields:_react.PropTypes.array,update:_react.PropTypes.func,_collectFieldsData:_react.PropTypes.func,getRequestString:_react.PropTypes.func,remove:_react.PropTypes.func,currentItemId:_react.PropTypes.oneOfType([_react.PropTypes.string,_react.PropTypes.boolean]),_uploadImage:_react.PropTypes.func,_addNewItem:_react.PropTypes.func};exports.default=View;